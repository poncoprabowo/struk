<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Struk Belanja - Toko</title>
  <style>
    body {
      font-family: 'Courier New', Courier, monospace;
      font-size: 16px;
      font-weight: bold;
      margin: 0;
      padding: 10px;
      background: #f4f4f4;
    }
    .form-container {
      margin-bottom: 20px;
      background: #fff;
      padding: 15px;
      border-radius: 8px;
      width: 100%;
      max-width: 600px;
      margin: auto;
    }
    label {
      display: block;
      margin-top: 10px;
      font-weight: bold;
    }
    input[type="text"], input[type="number"], input[type="date"], input[type="file"] {
      width: 100%;
      padding: 5px;
      margin-top: 5px;
      box-sizing: border-box;
      font-size: 14px;
    }
    button {
      margin-top: 10px;
      padding: 7px 12px;
      font-size: 14px;
      cursor: pointer;
      width: 100%;
    }
    .struk-container {
      background: #fff;
      width: 100%;
      max-width: 58mm;
      margin: 0 auto;
      padding: 1mm 3mm;
      box-shadow: 0 0 5px rgba(0,0,0,0.3);
      box-sizing: border-box;
      font-size: 14px;
    }
    .center {
      text-align: center;
    }
    .item-block {
      display: flex;
      flex-direction: column;
      gap: 2px;
    }
    .item-row {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
    }
    .total-text {
      font-size: 16px;
      font-weight: bold;
      text-align: right;
    }
    #printBtn, #savePdfBtn {
      display: none;
      margin: 10px auto;
      background-color: #007BFF;
      color: white;
    }
    @media print {
      * {
        visibility: hidden !important;
      }
      .struk-container,
      .struk-container * {
        visibility: visible !important;
        position: relative;
      }
      .struk-container {
        position: absolute;
        left: 0;
        top: 0;
        width: 56mm;
        max-width: 56mm;
        padding: 0mm 5mm;
        font-size: 12px;
        page-break-after: always;
      }
    }
  </style>
</head>
<body>

<div class="form-container">
  <h2>Input Data Struk Belanja</h2>
  <label for="toko">Nama Toko:</label>
  <input type="text" id="toko" placeholder="Masukkan nama toko">
  <label for="alamat">Alamat Toko:</label>
  <input type="text" id="alamat" placeholder="Masukkan alamat toko">
  <label for="kasir">Nama Kasir:</label>
  <input type="text" id="kasir" placeholder="Masukkan nama kasir">
  <label for="tanggal">Tanggal:</label>
  <input type="date" id="tanggal">
  <label for="excel">Upload Excel:</label>
  <input type="file" id="excel" accept=".xlsx, .xls" />
  <button onclick="downloadTemplate()" style="background: #4CAF50; color: white;">üì• Download Template Excel</button>
  <div id="belanjaan-list"></div>
  <button onclick="tambahBelanjaan()">Tambah Item</button>
  <button onclick="generateStruk()" style="background: green; color: white;">Tampilkan Struk</button>
  <button onclick="generateStrukAlternatif()" style="background: #007BFF; color: white;">Tampilkan Struk Alternatif</button>
  <button id="printBtn" onclick="window.print()">üñ®Ô∏è Cetak Struk</button>
  <button id="savePdfBtn" onclick="saveStrukToPDF()">üíæ Simpan Struk sebagai PDF</button>
</div>

<div class="struk-container" id="struk">
  <!-- Isi struk akan muncul di sini -->
</div>

<!-- SheetJS Library -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js "></script>

<!-- html2pdf.js Library -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js "></script>

<script>
  let itemCounter = 0;

  function getFormattedDate(date) {
    const day = String(date.getDate()).padStart(2, '0');
    const month = String(date.getMonth() + 1).padStart(2, '0');
    const year = date.getFullYear();
    return `${day}/${month}/${year}`;
  }

  function tambahBelanjaan() {
    itemCounter++;
    const list = document.getElementById('belanjaan-list');
    const div = document.createElement('div');
    div.id = `item-${itemCounter}`;
    div.innerHTML = `
      <hr>
      <label>Barang ${itemCounter}:</label><br>
      <input type="text" id="barang-${itemCounter}" placeholder="Nama barang">
      <input type="number" id="jumlah-${itemCounter}" placeholder="Jumlah" min="1" style="width: 60px;">
      <input type="number" id="harga-${itemCounter}" placeholder="Harga" min="0" style="width: 80px;">
      <button onclick="hapusItem(${itemCounter})" style="color: red;">Hapus</button>
    `;
    list.appendChild(div);
  }

  function hapusItem(id) {
    const el = document.getElementById(`item-${id}`);
    if (el) el.remove();
    itemCounter--;
  }

  function showPrintAndSaveButtons() {
    document.getElementById('printBtn').style.display = 'inline-block';
    document.getElementById('savePdfBtn').style.display = 'inline-block';
  }

  function generateStruk() {
    const toko = document.getElementById("toko").value || "Toko ABCD";
    const alamat = document.getElementById("alamat").value || "Jl. Raya No.123";
    const kasir = document.getElementById("kasir").value || "Kasir Tidak Diketahui";
    const tanggalInput = document.getElementById("tanggal").value;
    let tanggal = "";
    if (tanggalInput) {
      const [year, month, day] = tanggalInput.split('-');
      tanggal = `${day}/${month}/${year}`;
    } else {
      const now = new Date();
      tanggal = getFormattedDate(now);
    }

    let itemsHTML = '';
    let total = 0;

    for (let i = 1; i <= itemCounter; i++) {
      const barang = document.getElementById(`barang-${i}`)?.value.trim();
      const jumlah = parseInt(document.getElementById(`jumlah-${i}`)?.value) || 0;
      const harga = parseInt(document.getElementById(`harga-${i}`)?.value) || 0;

      if (barang && jumlah > 0 && harga >= 0) {
        const subtotal = jumlah * harga;
        total += subtotal;
        itemsHTML += `
          <div class="item-block">
            <div class="item-row">
              <div>${barang}</div>
            </div>
            <div class="item-row">
              <div>${jumlah} x Rp${formatRupiah(harga)}</div>
              <div>Rp${formatRupiah(subtotal)}</div>
            </div>
            <div style="border-top:1px dashed black;"></div>
          </div>`;
      }
    }

    const strukHTML = `
      <div class="center">
        <strong>${toko}</strong><br>
        ${alamat}<br>
        Kasir: ${kasir}<br>
        Tgl: ${tanggal}<br>
        ----------------------------
      </div>
      ${itemsHTML}
      <div style="border-top:2px solid black;margin:4px 0;"></div>
      <div style="text-align:right;font-weight:bold;">Total: Rp${formatRupiah(total)}</div>
      <div style="border-top:2px solid black;margin:4px 0;"></div>
      <div class="center">
        Terima Kasih<br>
        atas kunjungan Anda!
      </div>
    `;

    document.getElementById('struk').innerHTML = strukHTML;
    showPrintAndSaveButtons();
  }

  function generateStrukAlternatif() {
    const toko = document.getElementById("toko").value || "Toko ABCD";
    const alamat = document.getElementById("alamat").value || "Jl. Raya No.123";
    const kasir = document.getElementById("kasir").value || "Kasir Tidak Diketahui";
    const tanggalInput = document.getElementById("tanggal").value;
    let tanggal = "";
    if (tanggalInput) {
      const [year, month, day] = tanggalInput.split('-');
      tanggal = `${day}/${month}/${year}`;
    } else {
      const now = new Date();
      tanggal = getFormattedDate(now);
    }

    let itemsHTML = '';
    let total = 0;

    for (let i = 1; i <= itemCounter; i++) {
      const barang = document.getElementById(`barang-${i}`)?.value.trim();
      const jumlah = parseInt(document.getElementById(`jumlah-${i}`)?.value) || 0;
      const harga = parseInt(document.getElementById(`harga-${i}`)?.value) || 0;

      if (barang && jumlah > 0 && harga >= 0) {
        const subtotal = jumlah * harga;
        total += subtotal;
        itemsHTML += `
          <div class="item-block">
            <div class="item-row">
              <div>${barang}</div>
            </div>
            <div class="item-row">
              <div>${jumlah}</div>
              <div>Rp${formatRupiah(subtotal)}</div>
            </div>
            <div style="border-top:1px dashed black;"></div>
          </div>`;
      }
    }

    const strukHTML = `
      <div class="center">
        ${toko}<br>
        ${alamat}<br>
        Kasir: ${kasir}<br>
        Tanggal: ${tanggal}<br>
        ========================
      </div>
      ${itemsHTML}
      <div style="border-top:2px solid black;margin:4px 0;"></div>
      <div style="text-align:right;font-weight:bold;">Total: Rp${formatRupiah(total)}</div>
      <div style="border-top:2px solid black;margin:4px 0;"></div>
      <div class="center">
        Terima Kasih<br>
        atas kunjungan Anda!
      </div>
    `;

    document.getElementById('struk').innerHTML = strukHTML;
    showPrintAndSaveButtons();
  }

  function formatRupiah(angka) {
    return angka.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ".");
  }

  function saveStrukToPDF() {
    const element = document.getElementById('struk');

    // Hapus tombol jika ada dalam clone
    const clone = element.cloneNode(true);
    const buttons = clone.querySelectorAll("button");
    buttons.forEach(btn => btn.remove());

    const opt = {
      margin: [0, 0],
      filename: 'struk-belanja.pdf',
      image: { type: 'jpeg', quality: 0.98 },
      html2canvas: { scale: 2 },
      jsPDF: { unit: 'mm', format: [58, 297], orientation: 'portrait' }
    };

    html2pdf().set(opt).from(clone).save();
  }

  function downloadTemplate() {
    const now = new Date();
    const defaultDate = getFormattedDate(now);
    const wb = XLSX.utils.book_new();
    const wsData = [
      ["Nama Toko", "Toko Serba Ada"],
      ["Alamat Toko", "Jl. Raya No.123"],
      ["Nama Kasir", "Andi"],
      ["Tanggal", defaultDate],
      [],
      ["Barang", "Jumlah", "Harga"],
      ["Roti Tawar Gandum Super Enak", "2", "12000"],
      ["Susu Kotak Coklat Berkualitas Tinggi", "5", "5000"]
    ];
    const ws = XLSX.utils.aoa_to_sheet(wsData);
    XLSX.utils.book_append_sheet(wb, ws, "Struk");
    XLSX.writeFile(wb, "template-struk-belanja.xlsx");
  }

  document.getElementById('excel').addEventListener('change', function (e) {
    const file = e.target.files[0];
    if (!file) return;
    const reader = new FileReader();
    reader.onload = function (evt) {
      const data = new Uint8Array(evt.target.result);
      const workbook = XLSX.read(data, { type: 'array' });
      const sheetName = workbook.SheetNames[0];
      const sheet = workbook.Sheets[sheetName];

      document.getElementById("toko").value = sheet['B1']?.v || "";
      document.getElementById("alamat").value = sheet['B2']?.v || "";
      document.getElementById("kasir").value = sheet['B3']?.v || "";

      const cellTanggal = sheet['B4'];
      if (cellTanggal && typeof cellTanggal.v === 'number') {
        const parsedDate = XLSX.SSF.parse_date_code(cellTanggal.v);
        const formattedDate = `${parsedDate.d}/${parsedDate.m}/${parsedDate.y}`;
        document.getElementById("tanggal").value = formattedDate;
      } else if (cellTanggal && typeof cellTanggal.v === 'string') {
        const parts = cellTanggal.v.split('/');
        if (parts.length === 3) {
          const [d, m, y] = parts;
          document.getElementById("tanggal").value = `${y}-${m.padStart(2, '0')}-${d.padStart(2, '0')}`;
        }
      }

      const jsonData = XLSX.utils.sheet_to_json(sheet, { header: 1 });
      document.getElementById('belanjaan-list').innerHTML = '';
      itemCounter = 0;
      for (let i = 6; i < jsonData.length; i++) {
        const row = jsonData[i];
        if (row && row.length >= 3 && row[0] && row[1] !== undefined && row[2] !== undefined) {
          tambahBelanjaan();
          const idx = itemCounter;
          setTimeout(() => {
            document.getElementById(`barang-${idx}`).value = row[0];
            document.getElementById(`jumlah-${idx}`).value = row[1];
            document.getElementById(`harga-${idx}`).value = row[2];
          }, 50);
        }
      }
    };
    reader.readAsArrayBuffer(file);
  });
</script>

</body>
</html>
