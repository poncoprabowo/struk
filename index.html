<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Struk Belanja - Toko</title>

  <!-- Manifest PWA -->
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#007BFF">

  <style>
    body {
      font-family: 'Courier New', Courier, monospace;
      font-size: 16px;
      font-weight: bold;
      margin: 0;
      padding: 10px;
      background: #f4f4f4;
      box-sizing: border-box;
    }

    .form-container {
      margin-bottom: 20px;
      background: #fff;
      padding: 15px;
      border-radius: 8px;
      width: 100%;
      max-width: 600px;
      margin: auto;
      box-sizing: border-box;
    }

    label {
      display: block;
      margin-top: 10px;
      font-weight: bold;
    }

    input[type="text"],
    input[type="number"],
    input[type="file"] {
      width: 100%;
      padding: 5px;
      margin-top: 5px;
      box-sizing: border-box;
      font-size: 14px;
    }

    button {
      margin-top: 10px;
      padding: 7px 12px;
      font-size: 14px;
      cursor: pointer;
      width: 100%;
    }

    .struk-container {
      background: #fff;
      width: 100%;
      max-width: 58mm;
      margin: 0 auto;
      padding: 1mm 3mm;
      box-shadow: 0 0 5px rgba(0,0,0,0.3);
      box-sizing: border-box;
      font-size: 14px;
    }

    .center {
      text-align: center;
    }

    .item-block {
      display: flex;
      flex-direction: column;
      gap: 2px;
    }

    .item-row {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
    }

    .item-name {
      flex: 1 1 60%;
      word-break: break-word;
    }

    .line {
      border-top: 1px dashed #000;
      margin: 2px 0;
    }

    .total-line {
      border-top: 2px solid #000;
      margin: 4px 0;
    }

    .total-text {
      font-size: 16px;
      font-weight: bold;
      text-align: right;
    }

    #printBtn {
      display: none;
      margin: 10px auto;
      background-color: #007BFF;
      color: white;
      width: 100%;
    }

    @media screen and (max-width: 600px) {
      .struk-container {
        font-size: 12px;
        padding: 2mm;
      }
      input[type="text"], input[type="number"] {
        font-size: 14px;
      }
    }

    @media print {
      * {
        visibility: hidden !important;
      }
      .struk-container,
      .struk-container * {
        visibility: visible !important;
        position: relative;
      }
      .struk-container {
        position: absolute;
        left: 0;
        top: 0;
        width: 56mm;
        max-width: 56mm;
        padding: 0mm 5mm;
        font-size: 12px;
        page-break-after: always;
        box-sizing: border-box;
      }
      .total-text {
        font-size: 14px;
      }
      h2 {
        font-size: 14px;
      }
      .center strong {
        font-size: 14px;
      }
      .item-row div {
        font-size: 12px;
      }
    }
  </style>
</head>
<body>
<div class="form-container">
  <h2>Input Data Struk Belanja</h2>
  <label for="toko">Nama Toko:</label>
  <input type="text" id="toko" placeholder="Masukkan nama toko">
  <label for="alamat">Alamat Toko:</label>
  <input type="text" id="alamat" placeholder="Masukkan alamat toko">
  <label for="kasir">Nama Kasir:</label>
  <input type="text" id="kasir" placeholder="Masukkan nama kasir">
  <label for="excel">Upload Excel:</label>
  <input type="file" id="excel" accept=".xlsx, .xls" />
  <button onclick="downloadTemplate()" style="background: #4CAF50; color: white;">
    üì• Download Template Excel
  </button>
  <div id="belanjaan-list"></div>
  <button onclick="tambahBelanjaan()">Tambah Item</button>
  <button onclick="generateStruk()" style="background: green; color: white;">Tampilkan Struk</button>
  <button onclick="generateStrukAlternatif()" style="background: #007BFF; color: white;">Tampilkan Struk Alternatif</button>
  <button id="printBtn" onclick="window.print()">üñ®Ô∏è Cetak Struk</button>

  <!-- Tombol Hubungkan & Cetak ke Printer Thermal -->
  <button onclick="connectPrinter()" style="background: #ff9800; color: white;">üîå Hubungkan ke Printer</button>
  <button onclick="printStrukToBluetooth()" style="background: #d32f2f; color: white;">üñ®Ô∏è Cetak ke Printer Thermal</button>
</div>

<div class="struk-container" id="struk">
  <!-- Isi struk akan muncul di sini -->
</div>

<!-- SheetJS Library -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js "></script>

<!-- ESC/POS Encoder -->
<script type="module">
import EscPosEncoder from 'https://cdn.jsdelivr.net/npm/esc-pos-encoder/+esm ';

let characteristic = null;

// Fungsi: Hubungkan ke Printer Bluetooth
async function connectPrinter() {
    try {
        console.log("Memulai pencarian perangkat...");
        const device = await navigator.bluetooth.requestDevice({
            acceptAllDevices: true,
            optionalServices: ['0000110a-0000-1000-8000-00805f9b34fb']
        });

        console.log("Perangkat dipilih:", device.name);
        const server = await device.gatt.connect();
        const service = await server.getPrimaryService('0000110a-0000-1000-8000-00805f9b34fb');
        const chr = await service.getCharacteristic('0000110b-0000-1000-8000-00805f9b34fb');

        characteristic = chr;
        alert("‚úÖ Printer berhasil terhubung!");
    } catch (error) {
        console.error("Gagal terhubung ke printer:", error);
        alert("‚ùå Gagal terhubung ke printer.\nPastikan:\n1. Printer nyala\n2. Sudah dipairing\n3. Gunakan Chrome Android");
    }
}

// Fungsi: Kirim Data Struk ke Printer
function printStrukToBluetooth() {
    if (!characteristic) {
        alert("‚ö†Ô∏è Printer belum terhubung.");
        return;
    }

    const toko = document.getElementById("toko").value || "Toko Serba Ada";
    const alamat = document.getElementById("alamat").value || "";
    const kasir = document.getElementById("kasir").value || "Kasir";

    let items = [];
    for (let i = 1; i <= itemCounter; i++) {
        const barang = document.getElementById(`barang-${i}`)?.value || '';
        const jumlah = parseInt(document.getElementById(`jumlah-${i}`)?.value || 0);
        const harga = parseInt(document.getElementById(`harga-${i}`)?.value || 0);
        if (barang && jumlah > 0 && harga >= 0) {
            items.push({ nama: barang, jumlah, harga });
        }
    }

    // Buat encoder ESC/POS
    const encoder = new EscPosEncoder();
    const result = encoder
        .initialize()
        .align('ct')
        .line(toko)
        .line(alamat)
        .line("Kasir: " + kasir)
        .newline()
        .table([
            ["Barang", "Qty", "Harga"],
            ...items.map(i => [i.nama, i.jumlah, i.harga]),
        ])
        .newline()
        .text("----------------------------")
        .newline()
        .align('rt')
        .text("Total: " + items.reduce((sum, i) => sum + (i.jumlah * i.harga), 0).toLocaleString())
        .newline()
        .cut()
        .encode();

    characteristic.writeValue(result.buffer.slice(0, 20));
}
</script>

<script>
let itemCounter = 0;

function tambahBelanjaan() {
    itemCounter++;
    const list = document.getElementById('belanjaan-list');
    const div = document.createElement('div');
    div.id = `item-${itemCounter}`;
    div.innerHTML = `
      <hr>
      <label>Barang ${itemCounter}:</label><br>
      <input type="text" id="barang-${itemCounter}" placeholder="Nama barang">
      <input type="number" id="jumlah-${itemCounter}" placeholder="Jumlah" min="1" style="width: 60px;">
      <input type="number" id="harga-${itemCounter}" placeholder="Harga" min="0" style="width: 80px;">
      <button onclick="hapusItem(${itemCounter})" style="color: red;">Hapus</button>
    `;
    list.appendChild(div);
}

function hapusItem(id) {
    const el = document.getElementById(`item-${id}`);
    if (el) el.remove();
    itemCounter--;
}

function generateStruk() {
    const toko = document.getElementById("toko").value || "Toko ABCD";
    const alamat = document.getElementById("alamat").value || "Jl. Raya No.123";
    const kasir = document.getElementById("kasir").value || "Kasir Tidak Diketahui";
    const now = new Date();
    const tanggal = `${now.getDate()}/${now.getMonth()+1}/${now.getFullYear()}`;
    let itemsHTML = '';
    let total = 0;
    for (let i = 1; i <= itemCounter; i++) {
        const barang = document.getElementById(`barang-${i}`)?.value || '';
        const jumlah = parseInt(document.getElementById(`jumlah-${i}`)?.value || 0);
        const harga = parseInt(document.getElementById(`harga-${i}`)?.value || 0);
        if (barang && jumlah > 0 && harga >= 0) {
            const subtotal = jumlah * harga;
            total += subtotal;
            itemsHTML += `
              <div class="item-block">
                <div class="item-row">
                  <div class="item-name">${barang}</div>
                </div>
                <div class="item-row">
                  <div>${jumlah} x ${formatRupiah(harga)}</div>
                  <div><strong>= ${formatRupiah(subtotal)}</strong></div>
                </div>
                <div class="line"></div>
              </div>
            `;
        }
    }
    itemsHTML += `
      <div class="total-line"></div>
      <div class="total-text">Total: ${formatRupiah(total)}</div>
      <div class="total-line"></div>
    `;
    const strukHTML = `
      <div class="center">
        <strong>${toko}</strong><br>
        ${alamat}<br>
        Kasir: ${kasir}<br>
        Tgl: ${tanggal}<br>
        ----------------------------
      </div>
      ${itemsHTML}
      <div class="center">
        Terima Kasih<br>
        atas kunjungan Anda!
      </div>
    `;
    document.getElementById('struk').innerHTML = strukHTML;
    document.getElementById('printBtn').style.display = 'inline-block';
}

function generateStrukAlternatif() {
    const toko = document.getElementById("toko").value || "Toko ABCD";
    const alamat = document.getElementById("alamat").value || "Jl. Raya No.123";
    const kasir = document.getElementById("kasir").value || "Kasir Tidak Diketahui";
    const now = new Date();
    const tanggal = `${now.getDate()}/${now.getMonth()+1}/${now.getFullYear()}`;
    let itemsHTML = '';
    let total = 0;
    for (let i = 1; i <= itemCounter; i++) {
        const barang = document.getElementById(`barang-${i}`)?.value || '';
        const jumlah = parseInt(document.getElementById(`jumlah-${i}`)?.value || 0);
        const harga = parseInt(document.getElementById(`harga-${i}`)?.value || 0);
        if (barang && jumlah > 0 && harga >= 0) {
            const subtotal = jumlah * harga;
            total += subtotal;
            itemsHTML += `
              <div class="item-block">
                <div class="item-row">
                  <div class="item-name">${barang}</div>
                </div>
                <div class="item-row">
                  <div>${jumlah} x ${formatRupiah(harga)}</div>
                  <div><strong>${formatRupiah(subtotal)}</strong></div>
                </div>
                <div class="line"></div>
              </div>
            `;
        }
    }
    itemsHTML += `
      <div class="total-line"></div>
      <div class="total-text">Total: ${formatRupiah(total)}</div>
      <div class="total-line"></div>
    `;
    const strukHTML = `
      <div class="center">
        ${toko}<br>
        ${alamat}<br>
        Kasir: ${kasir}<br>
        Tanggal: ${tanggal}<br>
        ========================
      </div>
      ${itemsHTML}
      <div class="center">
        Terima Kasih<br>
        atas kunjungan Anda!
      </div>
    `;
    document.getElementById('struk').innerHTML = strukHTML;
    document.getElementById('printBtn').style.display = 'inline-block';
}

function formatRupiah(angka) {
    return angka.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ".");
}

function downloadTemplate() {
    const wb = XLSX.utils.book_new();
    const wsData = [
        ["Nama Toko", "Toko Serba Ada"],
        ["Alamat Toko", "Jl. Raya No.123"],
        ["Nama Kasir", "Andi"],
        [],
        ["Barang", "Jumlah", "Harga"],
        ["Roti Tawar", "2", "12000"],
        ["Susu Kotak", "5", "5000"]
    ];
    const ws = XLSX.utils.aoa_to_sheet(wsData);
    ws['!cols'] = [
        {wch:20}, {wch:10}, {wch:12}
    ];
    XLSX.utils.book_append_sheet(wb, ws, "Struk");
    XLSX.writeFile(wb, "template-struk-belanja.xlsx");
}

document.getElementById('excel').addEventListener('change', function (e) {
    const file = e.target.files[0];
    if (!file) return;
    const reader = new FileReader();
    reader.onload = function (evt) {
        const data = new Uint8Array(evt.target.result);
        const workbook = XLSX.read(data, { type: 'array' });
        const sheetName = workbook.SheetNames[0];
        const sheet = workbook.Sheets[sheetName];
        document.getElementById("toko").value = sheet['B1']?.v || "";
        document.getElementById("alamat").value = sheet['B2']?.v || "";
        document.getElementById("kasir").value = sheet['B3']?.v || "";
        const jsonData = XLSX.utils.sheet_to_json(sheet, { header: 1 });
        document.getElementById('belanjaan-list').innerHTML = '';
        itemCounter = 0;
        for (let i = 5; i < jsonData.length; i++) {
            const row = jsonData[i];
            if (row && row.length >= 3 && row[0] && row[1] !== undefined && row[2] !== undefined) {
                tambahBelanjaan();
                const idx = itemCounter;
                setTimeout(() => {
                    document.getElementById(`barang-${idx}`).value = row[0];     // Barang
                    document.getElementById(`jumlah-${idx}`).value = row[1];    // Jumlah
                    document.getElementById(`harga-${idx}`).value = row[2];     // Harga
                }, 50);
            }
        }
    };
    reader.readAsArrayBuffer(file);
});
</script>

<!-- Service Worker untuk Offline Support -->
<script>
if ('serviceWorker' in navigator) {
    navigator.serviceWorker.register('/sw.js').catch(err => console.error(err));
}
</script>
</body>
</html>
